本次会议讨论了NPU上Top-K、Top-P采样的实现方案，旨在解决标准库运算过慢的问题，并提出了一个高效的分割计算方案。

## 小结
**1. 采样加速背景与挑战**
-   构建投机推理服务时，需要在GPU或NPU上高效实现Top-K和Top-P采样策略，以稳定模型输出。
-   使用标准库的Apply Top-K/Top-P算子对完整logits矩阵排序，计算开销过大，无法满足NPU服务的高吞吐要求。
-   NPU的逻辑判断能力较弱，不建议采用Quick-Select等在CPU上成熟的复杂算法。

**2. 提出的Top-K与Top-P高效实现方案**
-   **Top-K实现**： 采用串行分割法。将概率数组平均切分成N段，逐段执行Top-K计算，然后将各段结果合并，得到整体的Top-K结果。该方法相较于全局排序更高效。
-   **Top-P实现**： 由于Top-P的“K”值未知，为避免low-efficiency的实现方式，提出二分支处理：
    -   首先尝试使用k=32的Top-K计算，检查其概率总和是否能覆盖设定的Top-P阈值。
    -   若32不足以覆盖，则执行一次完整的全局排序，再计算精确的Top-P结果。此方案基于经验数据，大部分模型的Top-32已能覆盖99%以上的概率。

## 待办
**1. 实现高效的Top-K和Top-P算子**
- 根据会议中的方案，开发一套针对NPU的高效Top-K和Top-P采样算子，并提供公开接口，服务于模型推理服务。

## 录屏
https://www.bilibili.com/video/BV1LaCxBzE8n/